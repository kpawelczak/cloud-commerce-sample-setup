import './polyfills.server.mjs';
import{c as re}from"./chunk-44SYVNXQ.mjs";import{c as B,f as V}from"./chunk-D7WZB62B.mjs";import{b as X,d as _,e as ee,f as te}from"./chunk-FWN422PK.mjs";import{kb as J,mb as W}from"./chunk-L3T7QQFM.mjs";import{$ as T,Aa as F,Ca as P,Ea as G,Fa as I,Fb as Y,Ha as Z,J as H,La as u,Ra as z,ab as Q,ec as b,f as O,fc as S,gc as $,ka as q,nb as K}from"./chunk-MYZEKFYU.mjs";import{$d as x,Aa as w,Fa as p,Ga as f,Ia as g,Ka as n,La as A,S as d,Sa as v,Td as m,Vd as C,X as L,cb as k,x as y,xa as E}from"./chunk-IDQ3VQP7.mjs";import{a as l}from"./chunk-GHFNAT2I.mjs";var N=new g("UserProfileNormalizer"),ae=new g("UserProfileSerializer"),ye=new g("UserSerializer"),ce=new g("UserSignUpSerializer"),de=new g("TitleNormalizer"),j=class{},U=(()=>{let t=class t{constructor(e){this.userProfileAdapter=e}update(e,r){return this.userProfileAdapter.update(e,r)}register(e){return this.userProfileAdapter.register(e)}registerGuest(e,r){return this.userProfileAdapter.registerGuest(e,r)}requestForgotPasswordEmail(e){return this.userProfileAdapter.requestForgotPasswordEmail(e)}resetPassword(e,r){return this.userProfileAdapter.resetPassword(e,r)}updateEmail(e,r,o){return this.userProfileAdapter.updateEmail(e,r,o)}updatePassword(e,r,o){return this.userProfileAdapter.updatePassword(e,r,o)}remove(e){return this.userProfileAdapter.close(e)}getTitles(){return this.userProfileAdapter.loadTitles()}};t.\u0275fac=function(r){return new(r||t)(n(j))},t.\u0275prov=p({token:t,factory:t.\u0275fac});let s=t;return s})(),ie=(()=>{let t=class t{constructor(e,r,o){this.userIdService=e,this.userProfileConnector=r,this.command=o,this.updateCommand=this.command.create(i=>this.userIdService.takeUserId(!0).pipe(E(a=>this.userProfileConnector.updateEmail(a,i.password,i.newUid))),{strategy:b.Queue})}update(e,r){return this.updateCommand.execute({password:e,newUid:r})}};t.\u0275fac=function(r){return new(r||t)(n(T),n(U),n(S))},t.\u0275prov=p({token:t,factory:t.\u0275fac});let s=t;return s})(),se=(()=>{let t=class t{constructor(e,r,o){this.userProfileConnector=e,this.userIdService=r,this.command=o,this.updateCommand=this.command.create(i=>this.userIdService.takeUserId(!0).pipe(L(1),E(a=>this.userProfileConnector.updatePassword(a,i.oldPassword,i.newPassword)))),this.resetCommand=this.command.create(i=>this.userProfileConnector.resetPassword(i.token,i.password)),this.requestForgotPasswordEmailCommand=this.command.create(i=>this.userProfileConnector.requestForgotPasswordEmail(i.email))}update(e,r){return this.updateCommand.execute({oldPassword:e,newPassword:r})}reset(e,r){return this.resetCommand.execute({token:e,password:r})}requestForgotPasswordEmail(e){return this.requestForgotPasswordEmailCommand.execute({email:e})}};t.\u0275fac=function(r){return new(r||t)(n(U),n(T),n(S))},t.\u0275prov=p({token:t,factory:t.\u0275fac});let s=t;return s})(),D=(()=>{let t=class t{constructor(e,r,o,i,a,c,h){this.userAccountService=e,this.authService=r,this.userProfileConnector=o,this.eventService=i,this.userIdService=a,this.query=c,this.command=h,this.updateCommand=this.command.create(R=>this.userIdService.takeUserId(!0).pipe(E(le=>this.userProfileConnector.update(le,R.details).pipe(w(()=>{this.eventService.dispatch({user:R.details},V)})))),{strategy:b.Queue}),this.closeCommand=this.command.create(()=>this.userIdService.takeUserId(!0).pipe(E(R=>this.userProfileConnector.remove(R).pipe(w(()=>this.authService.logout()))))),this.titleQuery=this.query.create(()=>this.userProfileConnector.getTitles(),{reloadOn:[Y]})}get(){return this.userAccountService.get()}update(e){return this.updateCommand.execute({details:e})}close(){return this.closeCommand.execute(void 0)}getTitles(){return this.titleQuery.get().pipe(y(e=>e??[]))}};t.\u0275fac=function(r){return new(r||t)(n(B),n(F),n(U),n(z),n(T),n($),n(S))},t.\u0275prov=p({token:t,factory:t.\u0275fac});let s=t;return s})(),oe=(()=>{let t=class t{constructor(e,r,o,i,a){this.userProfile=e,this.userConnector=r,this.authService=o,this.command=i,this.store=a,this.registerCommand=this.command.create(({user:c})=>this.userConnector.register(c).pipe(w(()=>{this.store.dispatch(new Q.RegisterUserSuccess)}))),this.registerGuestCommand=this.command.create(c=>this.userConnector.registerGuest(c.guid,c.password).pipe(w(h=>{this.authService.loginWithCredentials(h.uid,c.password)})))}register(e){return this.registerCommand.execute({user:e})}registerGuest(e,r){return this.registerGuestCommand.execute({guid:e,password:r})}getTitles(){return this.userProfile.getTitles()}};t.\u0275fac=function(r){return new(r||t)(n(D),n(U),n(F),n(S),n(O))},t.\u0275prov=p({token:t,factory:t.\u0275fac});let s=t;return s})(),fe=[ie,se,D,oe,{provide:_,useExisting:ie},{provide:ee,useExisting:se},{provide:X,useExisting:D},{provide:te,useExisting:oe}],ue=(()=>{let t=class t{};t.\u0275fac=function(r){return new(r||t)},t.\u0275mod=v({type:t}),t.\u0275inj=f({providers:[U,...fe]});let s=t;return s})();var ge={backend:{occ:{endpoints:{userRegister:"users",userForgotPassword:"forgottenpasswordtokens",userResetPassword:"resetpassword",userUpdateLoginId:"users/${userId}/login",userUpdatePassword:"users/${userId}/password",titles:"titles"}}}},pe={"Content-Type":"application/json"},M={"Content-Type":"application/x-www-form-urlencoded"},ve=(()=>{let t=class t{constructor(e,r,o){this.http=e,this.occEndpoints=r,this.converter=o,this.logger=A(q),this.captchaConfig=A(J,{optional:!0}),this.injector=A(k,{optional:!0})}update(e,r){let o=this.occEndpoints.isConfigured("userUpdateProfile")?"userUpdateProfile":"user",i=this.occEndpoints.buildUrl(o,{urlParams:{userId:e}});return r=this.converter.convert(r,ae),this.http.patch(i,r).pipe(d(a=>{throw u(a,this.logger)}))}register(e){let r=this.occEndpoints.buildUrl("userRegister"),o=new m(l({},pe));return o=I.createHeader(P,!0,o),o=this.appendCaptchaToken(o),e=this.converter.convert(e,ce),this.http.post(r,e,{headers:o}).pipe(d(i=>{throw u(i,this.logger)}),this.converter.pipeable(N))}registerGuest(e,r){let o=this.occEndpoints.buildUrl("userRegister"),i=new m(l({},M));i=I.createHeader(P,!0,i),i=this.appendCaptchaToken(i);let a=new C().set("guid",e).set("password",r);return this.http.post(o,a,{headers:i}).pipe(d(c=>{throw u(c,this.logger)}),this.converter.pipeable(N))}requestForgotPasswordEmail(e){let r=this.occEndpoints.buildUrl("userForgotPassword"),o=new C().set("userId",e),i=new m(l({},M));return i=I.createHeader(P,!0,i),this.http.post(r,o,{headers:i}).pipe(d(a=>{throw u(a,this.logger)}))}resetPassword(e,r){let o=this.occEndpoints.buildUrl("userResetPassword"),i=new m(l({},pe));return i=I.createHeader(P,!0,i),this.http.post(o,{token:e,newPassword:r},{headers:i}).pipe(d(a=>{throw u(a,this.logger)}))}updateEmail(e,r,o){let i=this.occEndpoints.buildUrl("userUpdateLoginId",{urlParams:{userId:e}}),a=new C().set("password",r).set("newLogin",o),c=new m(l({},M));return this.http.put(i,a,{headers:c}).pipe(d(h=>{throw u(h,this.logger)}))}updatePassword(e,r,o){let i=this.occEndpoints.buildUrl("userUpdatePassword",{urlParams:{userId:e}}),a=new C().set("old",r).set("new",o),c=new m(l({},M));return this.http.put(i,a,{headers:c}).pipe(d(h=>{throw u(h,this.logger)}))}close(e){let r=this.occEndpoints.isConfigured("userCloseAccount")?"userCloseAccount":"user",o=this.occEndpoints.buildUrl(r,{urlParams:{userId:e}});return this.http.delete(o).pipe(d(i=>{throw u(i,this.logger)}))}loadTitles(){let e=this.occEndpoints.buildUrl("titles");return this.http.get(e).pipe(d(r=>{throw u(r,this.logger)}),y(r=>r.titles??[]),this.converter.pipeableMany(de))}appendCaptchaToken(e){if(this.injector&&this.captchaConfig?.captchaRenderer){let r=this.injector.get(this.captchaConfig.captchaRenderer),o=r.getCaptchaConfig().subscribe(i=>i.enabled);if(r?.getToken()&&o)return e.append(G,r.getToken())}return e}};t.\u0275fac=function(r){return new(r||t)(n(x),n(Z),n(K))},t.\u0275prov=p({token:t,factory:t.\u0275fac});let s=t;return s})(),he=(()=>{let t=class t{};t.\u0275fac=function(r){return new(r||t)},t.\u0275mod=v({type:t}),t.\u0275inj=f({providers:[H(ge),{provide:j,useClass:ve}]});let s=t;return s})();var Qe=(()=>{let t=class t{};t.\u0275fac=function(r){return new(r||t)},t.\u0275mod=v({type:t}),t.\u0275inj=f({imports:[ue,he,re,W]});let s=t;return s})();export{Qe as UserProfileModule};
